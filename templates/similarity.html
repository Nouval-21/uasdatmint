{% extends "layout.html" %} {% block content %}

<h3 class="mb-4">üîç Perhitungan Kemiripan Dokumen</h3>

<!-- Search Form -->
<div class="card p-4 mb-4">
  <form method="POST" id="searchForm">
    <label class="form-label fw-bold">Masukkan Query:</label>

    <div class="input-group">
      <input
        type="text"
        id="queryInput"
        name="query"
        class="form-control form-control-lg"
        placeholder="contoh: modul python"
        value="{{ query if query else '' }}"
        list="suggestions"
        required
      />
      <button class="btn btn-primary">
        <i class="bi bi-search"></i> Hitung Similarity
      </button>
    </div>

    <datalist id="suggestions">
      <option value="modul"></option>
      <option value="python"></option>
      <option value="java"></option>
      <option value="pembelajaran"></option>
      <option value="dasar"></option>
      <option value="program"></option>
      <option value="objek"></option>
    </datalist>
  </form>

  <div id="loadingSpinner" class="text-center mt-3" style="display: none">
    <div class="spinner-border text-primary"></div>
    <p class="text-muted mt-2">Sedang memproses query...</p>
  </div>
</div>

<!-- Search History -->
<div class="card p-3 mb-4">
  <div class="d-flex justify-content-between align-items-center">
    <h6 class="mb-0">üïê Riwayat Pencarian</h6>
    <button class="btn btn-sm btn-outline-danger" onclick="clearHistory()">
      Hapus Semua
    </button>
  </div>
  <div id="searchHistory" class="mt-2"></div>
</div>

{% if results is not none %}
<div class="fade-in">
  {% if total_found >= 3 %}
  <div
    class="card p-4 mb-4"
    style="background: linear-gradient(135deg, #0891b2, #059669); color: white"
  >
    <h5>üèÜ Top 3 Dokumen Paling Relevan</h5>
    <ol>
      {% for filename, score in results[:3] %}
      <li>
        <strong>{{ filename }}</strong>
        <span class="badge" style="background: rgba(255, 255, 255, 0.3)"
          >{{ "%.0f"|format(score * 100) }}%</span
        >
      </li>
      {% endfor %}
    </ol>
  </div>
  {% endif %}

  <!-- Results with Summaries -->
  <div class="card p-4 mb-4">
    <h5 class="mb-1">
      üìä Hasil Query: "<span style="color: #0891b2">{{ query }}</span>"
    </h5>

    {% if total_found > 0 %}
    <p class="text-muted">
      Ditemukan <b style="color: #059669">{{ total_found }}</b> dokumen relevan
    </p>
    <a href="/export-csv/{{ query }}" class="btn btn-success btn-sm mb-3">
      <i class="bi bi-download"></i> Export CSV
    </a>

    <!-- Document Cards with Ranking and Summary -->
    {% for filename, score in results %} {% set pct = score * 100 %}
    <div class="card mb-3 result-card">
      <div class="card-body">
        <div class="row">
          <div class="col-md-1 text-center">
            <div class="rank-badge">
              <span class="h4 mb-0">{{ loop.index }}</span>
            </div>
          </div>

          <div class="col-md-8">
            <h6 class="mb-2">
              <a href="/process/{{ filename }}" class="text-decoration-none">
                {% if filename.endswith('.pdf') %}üìÑ {% elif
                filename.endswith('.docx') %}üìù {% else %}üìã{% endif %}
                <span class="filename-text">{{ filename }}</span>
              </a>
            </h6>

            <!-- Ringkasan Dokumen -->
            <div
              class="alert alert-light mb-2 p-2"
              style="border-left: 3px solid #0891b2"
            >
              <small class="text-muted">
                <i class="bi bi-file-text"></i> <strong>Ringkasan:</strong
                ><br />
                {{ summaries[filename][:250] if summaries and filename in
                summaries else 'Ringkasan tidak tersedia' }} {% if summaries and
                filename in summaries and summaries[filename]|length > 250
                %}...{% endif %}
              </small>
            </div>

            <div class="mt-2">
              <a
                href="/summary/{{ filename }}"
                class="btn btn-sm btn-outline-info me-2"
              >
                <i class="bi bi-file-text"></i> Lihat Ringkasan Lengkap
              </a>
              <a
                href="/process/{{ filename }}"
                class="btn btn-sm btn-outline-primary"
              >
                <i class="bi bi-gear"></i> Preprocessing
              </a>
            </div>
          </div>

          <div class="col-md-3 text-center">
            <div class="score-display">
              <div class="mb-2">
                <span class="text-muted small">Similarity Score</span>
              </div>
              <div class="mb-2">
                <code class="h5" style="color: #1e3a8a"
                  >{{ "%.4f"|format(score) }}</code
                >
              </div>
              <div>
                {% if pct >= 5 %}
                <span
                  class="badge bg-success"
                  style="font-size: 1rem; padding: 8px 15px"
                  >{{ "%.0f"|format(pct) }}%</span
                >
                {% elif pct >= 1 %}
                <span
                  class="badge"
                  style="
                    background: #ea580c;
                    font-size: 1rem;
                    padding: 8px 15px;
                  "
                  >{{ "%.0f"|format(pct) }}%</span
                >
                {% else %}
                <span
                  class="badge bg-secondary"
                  style="font-size: 1rem; padding: 8px 15px"
                  >{{ "%.0f"|format(pct) }}%</span
                >
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %} {% else %}
    <div class="alert alert-warning mt-3">
      <h5>üòï Tidak ada dokumen relevan</h5>
      <p>Coba gunakan kata kunci yang lebih spesifik.</p>
    </div>
    {% endif %}
  </div>

  {% if total_found > 0 %}
  <!-- Visualisasi Similarity Score -->
  <div class="card p-4 mb-4">
    <h5 class="mb-3">üìä Visualisasi Similarity Score</h5>
    <canvas id="similarityChart" style="max-height: 400px"></canvas>
  </div>
  {% endif %}
</div>
{% endif %}

<!-- Inject Chart Data -->
{% if results and total_found > 0 %}
<script id="chartData" type="application/json">
  {
    "labels": [
      {% for filename, score in results %}
      "{{ filename[:35]|replace('"', '\\"') }}..."{% if not loop.last %},{% endif %}
      {% endfor %}
    ],
    "values": [
      {% for filename, score in results %}
      {{ score }}{% if not loop.last %},{% endif %}
      {% endfor %}
    ]
  }
</script>
{% endif %}

<!-- Inject Query for Highlighting -->
{% if query %}
<script id="queryData" type="application/json">
  {
    "query": "{{ query|replace('"', '\\"')|replace('\\', '\\\\') }}"
  }
</script>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Chart Initialization
  document.addEventListener("DOMContentLoaded", function () {
    var chartDataEl = document.getElementById("chartData");

    if (chartDataEl) {
      try {
        var chartData = JSON.parse(chartDataEl.textContent);
        var labels = chartData.labels;
        var values = chartData.values;

        var colors = values.map(function (v) {
          if (v >= 0.05) return "rgba(5,150,105,0.8)";
          if (v >= 0.01) return "rgba(234,88,12,0.8)";
          return "rgba(100,116,139,0.8)";
        });

        new Chart(document.getElementById("similarityChart"), {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                data: values,
                backgroundColor: colors,
                borderColor: colors.map(function (c) {
                  return c.replace("0.8", "1");
                }),
                borderWidth: 2,
                borderRadius: 8,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
            },
          },
        });
      } catch (err) {
        console.error("Error creating chart:", err);
      }
    }
  });

  // Search History Functions
  function displayHistory() {
    var history = JSON.parse(localStorage.getItem("searchHistory") || "[]");
    var div = document.getElementById("searchHistory");

    if (history.length === 0) {
      div.innerHTML = "<small class='text-muted'>Belum ada riwayat</small>";
      return;
    }

    div.innerHTML = history
      .map(function (q) {
        var escaped = q.replace(/'/g, "\\'");
        return (
          '<button class="btn btn-sm btn-outline-primary me-2 mb-2" onclick="useQuery(\'' +
          escaped +
          "')\">" +
          q +
          "</button>"
        );
      })
      .join("");
  }

  function useQuery(q) {
    document.getElementById("queryInput").value = q;
  }

  function clearHistory() {
    localStorage.removeItem("searchHistory");
    displayHistory();
  }

  // Form Submit Handler
  document.getElementById("searchForm").addEventListener("submit", function () {
    document.getElementById("loadingSpinner").style.display = "block";
  });

  // Initialize History
  displayHistory();

  // Save Current Query to History
  document.addEventListener("DOMContentLoaded", function () {
    var queryDataEl = document.getElementById("queryData");

    if (queryDataEl) {
      try {
        var queryData = JSON.parse(queryDataEl.textContent);
        var currentQuery = queryData.query;

        // Save to history
        var h = JSON.parse(localStorage.getItem("searchHistory") || "[]");
        h = h.filter(function (x) {
          return x !== currentQuery;
        });
        h.unshift(currentQuery);
        h = h.slice(0, 5);
        localStorage.setItem("searchHistory", JSON.stringify(h));
        displayHistory();

        // Highlight query in results
        var q = currentQuery;
        document.querySelectorAll(".filename-text").forEach(function (el) {
          var raw = el.textContent;
          var escapedQ = q.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
          var regex = new RegExp("(" + escapedQ + ")", "gi");
          el.innerHTML = raw.replace(
            regex,
            '<mark style="background:#fef3c7; font-weight:bold; color:#92400e;">$1</mark>'
          );
        });
      } catch (err) {
        console.error("Error processing query data:", err);
      }
    }
  });
</script>

<style>
  .fade-in {
    animation: fadeIn 0.6s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: none;
    }
  }

  .result-card {
    transition: all 0.3s ease;
    border-left: 4px solid #0891b2;
  }

  .result-card:hover {
    transform: translateX(5px);
    box-shadow: 0 5px 15px rgba(8, 145, 178, 0.2);
  }

  .rank-badge {
    background: linear-gradient(135deg, #1e3a8a 0%, #0891b2 100%);
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }

  .score-display {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    border: 1px solid rgba(8, 145, 178, 0.2);
  }
</style>

{% endblock %}
